name: Generate Skills

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      skill_name:
        description: 'Specific skill to generate (optional, leave empty to generate all)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    name: Generate and Update Skills
    runs-on: ubuntu-latest

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: pip

      - name: Setup Node.js and pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.14.0'
          cache: pnpm

      - name: Install root dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Python dependencies
        working-directory: backend/python
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run skill generator
        working-directory: backend
        env:
          LLM_BASE_URL: ${{ secrets.LLM_BASE_URL || 'https://api.anthropic.com/v1' }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_MODEL: ${{ secrets.LLM_MODEL || 'claude-3-5-sonnet-20241022' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${{ github.event.inputs.skill_name }}" ]; then
            pnpm run generate -- --skills "${{ github.event.inputs.skill_name }}"
          else
            pnpm run generate
          fi

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Validate generated skills
        if: steps.check_changes.outputs.has_changes == 'true'
        run: pnpm run validate-all-skills

      - name: Configure Git
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Create feature branch
        if: steps.check_changes.outputs.has_changes == 'true'
        id: create_branch
        run: |
          TIMESTAMP=$(date -u +'%Y%m%d-%H%M%S')
          BRANCH_NAME="generate/skills-${TIMESTAMP}"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Commit changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git add packages/skills-registry/
          git commit -m "docs(skills): auto-generate skills from official sources

          - Updated skill definitions from latest documentation
          - Normalized content through LLM processing
          - Validated against quality standards

          Generated by GitHub Actions"

      - name: Push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: git push origin "${{ steps.create_branch.outputs.branch_name }}"

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const timestamp = new Date().toISOString().slice(0, 10);
            const branchName = '${{ steps.create_branch.outputs.branch_name }}';

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `chore(skills): auto-generate skills - ${timestamp}`,
              head: branchName,
              base: 'main',
              body: `## Auto-generated Skills Update

            Generated at: ${new Date().toISOString()}

            ### Changes
            - Updated SKILLS.md files with latest documentation
            - All skills validated against schema
            - Content normalized through LLM processing

            ### Review Checklist
            - [ ] Verify skill content accuracy
            - [ ] Check for any breaking changes
            - [ ] Validate schema compliance

            *This PR was automatically generated by the Skills Generator workflow.*`
            });

            core.notice(\`Pull Request created: #\${pr.data.number}\`);

      - name: Create Release (if version bumped)
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const currentPkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            const version = currentPkg.version;

            try {
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/v${version}`
              });
              core.info(`Release v${version} already exists, skipping creation`);
            } catch (error) {
              if (error.status === 404) {
                const release = await github.rest.repos.createRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag_name: `v${version}`,
                  name: `Release v${version}`,
                  body: `## Skills Registry v${version}

            Auto-generated skills update released on ${new Date().toISOString().slice(0, 10)}.

            See CHANGELOG.md for full details.`,
                  draft: false,
                  prerelease: false
                });
                core.notice(`Release created: v${version}`);
              }
            }

      - name: Post status comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? '✅' : '❌';
            const summary = `${emoji} Skills generation workflow ${status}`;

            core.summary
              .addHeading('Workflow Summary')
              .addRaw(summary)
              .write();
